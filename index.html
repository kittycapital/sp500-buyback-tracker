<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&P 500 자사주 매입 트래커</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0a0f;
  --bg-card: #12121a;
  --bg-card-hover: #1a1a28;
  --border: #1e1e30;
  --text-primary: #e8e8f0;
  --text-secondary: #8888a8;
  --text-muted: #55556a;
  --accent-blue: #4a90ff;
  --accent-cyan: #00d4aa;
  --accent-purple: #a855f7;
  --accent-orange: #ff8c42;
  --accent-red: #ff4d6a;
  --accent-yellow: #ffd644;
  --accent-green: #22c55e;
  --sector-tech: #4a90ff;
  --sector-finance: #22c55e;
  --sector-health: #ff4d6a;
  --sector-consumer-disc: #ff8c42;
  --sector-consumer-staple: #a855f7;
  --sector-energy: #ffd644;
  --sector-industrial: #00d4aa;
  --sector-materials: #e879a0;
  --sector-realestate: #64748b;
  --sector-utilities: #818cf8;
  --sector-comm: #f97316;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: 'Noto Sans KR', sans-serif;
  line-height: 1.6;
  overflow-x: hidden;
}

.mono { font-family: 'JetBrains Mono', monospace; }

/* Header */
.header {
  padding: 48px 24px 32px;
  text-align: center;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, #0f0f1a 0%, var(--bg-primary) 100%);
}

.header-badge {
  display: inline-block;
  padding: 4px 14px;
  border: 1px solid var(--accent-cyan);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  color: var(--accent-cyan);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 16px;
}

.header h1 {
  font-size: clamp(24px, 5vw, 40px);
  font-weight: 900;
  background: linear-gradient(135deg, #e8e8f0 30%, var(--accent-cyan) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
}

.header p {
  color: var(--text-secondary);
  font-size: 14px;
  max-width: 600px;
  margin: 0 auto;
}

/* Stats Bar */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1px;
  background: var(--border);
  border-bottom: 1px solid var(--border);
}

.stat-item {
  background: var(--bg-card);
  padding: 20px 16px;
  text-align: center;
}

.stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 22px;
  font-weight: 700;
  color: var(--accent-cyan);
}

.stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 4px;
}

/* Sections */
.section {
  padding: 40px 20px;
  border-bottom: 1px solid var(--border);
  max-width: 1100px;
  margin: 0 auto;
}

.section-header {
  margin-bottom: 28px;
}

.section-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--accent-cyan);
  letter-spacing: 2px;
  display: block;
  margin-bottom: 6px;
}

.section-title {
  font-size: clamp(18px, 3.5vw, 26px);
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 6px;
}

.section-desc {
  font-size: 13px;
  color: var(--text-secondary);
}

/* Chart containers */
.chart-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px 16px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.chart-wrap canvas {
  max-height: 500px;
}

/* Buyback ranking bars */
.rank-list { display: flex; flex-direction: column; gap: 6px; }

.rank-item {
  display: grid;
  grid-template-columns: 32px 70px 1fr 100px;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  transition: background 0.2s;
}

.rank-item:hover { background: var(--bg-card-hover); }

.rank-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text-muted);
  text-align: center;
}

.rank-ticker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  color: var(--accent-blue);
}

.rank-bar-wrap {
  height: 22px;
  background: #1a1a28;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.rank-bar {
  height: 100%;
  border-radius: 4px;
  transition: width 0.8s ease;
  min-width: 2px;
}

.rank-bar-label {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-secondary);
}

.rank-amount {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text-primary);
  text-align: right;
}

/* Sector legend */
.sector-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--text-secondary);
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 2px;
  flex-shrink: 0;
}

/* Buyback yield table */
.yield-table {
  width: 100%;
  border-collapse: collapse;
}

.yield-table th {
  text-align: left;
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
}

.yield-table td {
  padding: 10px 12px;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

.yield-table tr:hover { background: var(--bg-card-hover); }

.yield-val {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
}

.yield-positive { color: var(--accent-cyan); }
.yield-sector {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  background: #1a1a28;
  color: var(--text-secondary);
}

/* Breadth bars */
.breadth-legend {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.breadth-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-secondary);
}

.breadth-legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 3px;
}

/* Data status */
.data-status {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.data-status .spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent-cyan);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Footer */
.footer {
  text-align: center;
  padding: 32px 20px;
  font-size: 11px;
  color: var(--text-muted);
}

/* Responsive */
@media (max-width: 640px) {
  .rank-item {
    grid-template-columns: 28px 56px 1fr 80px;
    gap: 6px;
    padding: 6px 8px;
  }
  .section { padding: 28px 14px; }
  .chart-wrap { padding: 16px 10px; }
  .stats-bar { grid-template-columns: repeat(2, 1fr); }
  .yield-table { font-size: 11px; }
  .yield-table td, .yield-table th { padding: 8px 6px; }
}

/* Tab selector */
.tab-bar {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-btn {
  padding: 6px 16px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: transparent;
  color: var(--text-secondary);
  font-size: 12px;
  font-family: 'Noto Sans KR', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
}

.tab-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
.tab-btn.active {
  background: var(--accent-cyan);
  color: #000;
  border-color: var(--accent-cyan);
  font-weight: 600;
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-badge">S&P 500 Buyback Tracker</div>
  <h1>자사주 매입 트래커</h1>
  <p>S&P 500 기업들의 자사주 매입 현황을 실시간으로 추적합니다</p>
  <p style="margin-top:8px;font-size:12px;color:var(--text-muted)">
    업데이트: <span id="lastUpdate" class="mono">-</span> · 
    수집: <span id="coverage" class="mono">-</span>
  </p>
</div>

<!-- Stats Bar -->
<div class="stats-bar">
  <div class="stat-item">
    <div class="stat-value" id="statTotalBuyback">-</div>
    <div class="stat-label">총 매입 규모 (TTM)</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statActiveCount">-</div>
    <div class="stat-label">매입 활동 기업 수</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statTopSector">-</div>
    <div class="stat-label">최대 매입 섹터</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statAvgYield">-</div>
    <div class="stat-label">평균 매입 수익률</div>
  </div>
</div>

<!-- Section 1: Buyback Ranking -->
<div class="section" id="sec1">
  <div class="section-header">
    <span class="section-num">01</span>
    <div class="section-title">자사주 매입 규모 랭킹</div>
    <div class="section-desc">최근 4분기(TTM) 기준 자사주 매입 금액 상위 30개 기업</div>
  </div>
  <div class="tab-bar" id="rankTabs">
    <button class="tab-btn active" data-view="amount">매입 금액</button>
    <button class="tab-btn" data-view="yield">매입 수익률</button>
  </div>
  <div id="rankListContainer">
    <div class="data-status"><div class="spinner"></div>데이터 로딩중...</div>
  </div>
</div>

<!-- Section 2: Overall Trend -->
<div class="section" id="sec2">
  <div class="section-header">
    <span class="section-num">02</span>
    <div class="section-title">S&P 500 전체 자사주 매입 추이</div>
    <div class="section-desc">분기별 S&P 500 기업 전체의 자사주 매입 총액</div>
  </div>
  <div class="chart-wrap">
    <canvas id="trendChart"></canvas>
  </div>
</div>

<!-- Section 3: Sector Breakdown -->
<div class="section" id="sec3">
  <div class="section-header">
    <span class="section-num">03</span>
    <div class="section-title">섹터별 매입 비중</div>
    <div class="section-desc">GICS 섹터별 분기 자사주 매입 금액 비중</div>
  </div>
  <div class="chart-wrap">
    <canvas id="sectorChart"></canvas>
  </div>
</div>

<!-- Section 4: Buyback Yield Ranking -->
<div class="section" id="sec4">
  <div class="section-header">
    <span class="section-num">04</span>
    <div class="section-title">매입 수익률 TOP 20</div>
    <div class="section-desc">자사주 매입액 ÷ 시가총액으로 계산한 매입 수익률 상위 기업</div>
  </div>
  <div class="chart-wrap" style="overflow-x:auto">
    <table class="yield-table" id="yieldTable">
      <thead>
        <tr>
          <th>#</th>
          <th>티커</th>
          <th>기업명</th>
          <th>섹터</th>
          <th>매입 수익률</th>
          <th>매입 금액 (TTM)</th>
        </tr>
      </thead>
      <tbody id="yieldBody">
        <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px">데이터 로딩중...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Section 5: Participation Breadth -->
<div class="section" id="sec5">
  <div class="section-header">
    <span class="section-num">05</span>
    <div class="section-title">매입 기업 수 추이</div>
    <div class="section-desc">분기별 자사주 매입 활동 기업 수 (매입 강도별 분류)</div>
  </div>
  <div class="breadth-legend">
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:var(--accent-cyan)"></div>대규모 매입 (매출의 3%↑)</div>
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:var(--accent-blue)"></div>중간 매입</div>
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:var(--accent-purple)"></div>소규모 매입</div>
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:#2a2a3a"></div>매입 없음</div>
  </div>
  <div class="chart-wrap">
    <canvas id="breadthChart"></canvas>
  </div>
</div>

<!-- Footer -->
<div class="footer">
  데이터 출처: Financial Modeling Prep · 매일 50개 종목 업데이트 (10일 주기 순환)<br>
  자사주 매입 데이터는 분기 재무제표 기반이며, 실시간 매입 집행 내역과 다를 수 있습니다.
</div>

<script>
// ============================================
// CONFIGURATION & GLOBALS
// ============================================
const DATA_URL = 'buyback_data.json';

const SECTOR_COLORS = {
  'Technology': '#4a90ff',
  'Information Technology': '#4a90ff',
  'Financial Services': '#22c55e',
  'Financials': '#22c55e',
  'Healthcare': '#ff4d6a',
  'Health Care': '#ff4d6a',
  'Consumer Cyclical': '#ff8c42',
  'Consumer Discretionary': '#ff8c42',
  'Consumer Defensive': '#a855f7',
  'Consumer Staples': '#a855f7',
  'Energy': '#ffd644',
  'Industrials': '#00d4aa',
  'Basic Materials': '#e879a0',
  'Materials': '#e879a0',
  'Real Estate': '#64748b',
  'Utilities': '#818cf8',
  'Communication Services': '#f97316',
};

const SECTOR_KO = {
  'Technology': '기술',
  'Information Technology': '기술',
  'Financial Services': '금융',
  'Financials': '금융',
  'Healthcare': '헬스케어',
  'Health Care': '헬스케어',
  'Consumer Cyclical': '경기소비재',
  'Consumer Discretionary': '경기소비재',
  'Consumer Defensive': '필수소비재',
  'Consumer Staples': '필수소비재',
  'Energy': '에너지',
  'Industrials': '산업재',
  'Basic Materials': '소재',
  'Materials': '소재',
  'Real Estate': '부동산',
  'Utilities': '유틸리티',
  'Communication Services': '커뮤니케이션',
};

function getSectorColor(sector) {
  return SECTOR_COLORS[sector] || '#666';
}

function getSectorKo(sector) {
  return SECTOR_KO[sector] || sector;
}

function formatBillions(val) {
  const abs = Math.abs(val);
  if (abs >= 1e12) return `$${(abs / 1e12).toFixed(1)}T`;
  if (abs >= 1e9) return `$${(abs / 1e9).toFixed(1)}B`;
  if (abs >= 1e6) return `$${(abs / 1e6).toFixed(0)}M`;
  return `$${abs.toLocaleString()}`;
}

function formatKoreanBillions(val) {
  const abs = Math.abs(val);
  const 조 = 1e12;
  const 억 = 1e8;
  if (abs >= 조) return `${(abs / 조).toFixed(1)}조원`;
  if (abs >= 억 * 100) return `${(abs / 억).toFixed(0)}억원`;
  return `${(abs / 억).toFixed(1)}억원`;
}

// ============================================
// DATA PROCESSING
// ============================================

function getTTMBuyback(quarters) {
  // Get most recent 4 quarters
  const sorted = [...quarters].sort((a, b) => b.date.localeCompare(a.date));
  const recent4 = sorted.slice(0, 4);
  // commonStockRepurchased is negative (cash outflow), so sum and negate
  return recent4.reduce((sum, q) => sum + Math.abs(Math.min(q.buyback_amount, 0)), 0);
}

function getLatestShares(quarters) {
  const sorted = [...quarters].sort((a, b) => b.date.localeCompare(a.date));
  return sorted[0]?.shares_outstanding || 0;
}

function getQuarterLabel(dateStr) {
  const d = new Date(dateStr);
  const q = Math.ceil((d.getMonth() + 1) / 3);
  return `${d.getFullYear()} Q${q}`;
}

function getAllQuarters(data) {
  const qSet = new Set();
  Object.values(data).forEach(d => {
    d.quarters.forEach(q => qSet.add(getQuarterLabel(q.date)));
  });
  return [...qSet].sort();
}

function getQuarterlyAggregates(data) {
  const quarters = {};
  Object.entries(data).forEach(([symbol, info]) => {
    info.quarters.forEach(q => {
      const label = getQuarterLabel(q.date);
      if (!quarters[label]) quarters[label] = { total: 0, bySector: {}, companies: { heavy: 0, medium: 0, light: 0, none: 0 } };
      const buyback = Math.abs(Math.min(q.buyback_amount, 0));
      quarters[label].total += buyback;

      const sector = info.sector || 'Unknown';
      quarters[label].bySector[sector] = (quarters[label].bySector[sector] || 0) + buyback;

      // Categorize intensity (rough thresholds)
      if (buyback > 1e9) quarters[label].companies.heavy++;
      else if (buyback > 1e8) quarters[label].companies.medium++;
      else if (buyback > 0) quarters[label].companies.light++;
      else quarters[label].companies.none++;
    });
  });
  return quarters;
}

// ============================================
// RENDERING
// ============================================

function renderStats(data) {
  let totalTTM = 0;
  let activeCount = 0;
  const sectorTotals = {};

  Object.values(data).forEach(info => {
    const ttm = getTTMBuyback(info.quarters);
    totalTTM += ttm;
    if (ttm > 0) activeCount++;
    const sector = info.sector || 'Unknown';
    sectorTotals[sector] = (sectorTotals[sector] || 0) + ttm;
  });

  document.getElementById('statTotalBuyback').textContent = formatBillions(totalTTM);
  document.getElementById('statActiveCount').textContent = `${activeCount}개`;

  const topSector = Object.entries(sectorTotals).sort((a, b) => b[1] - a[1])[0];
  document.getElementById('statTopSector').textContent = topSector ? getSectorKo(topSector[0]) : '-';

  // Average buyback yield (rough - using shares * approximate price from free cash flow ratio)
  document.getElementById('statAvgYield').textContent = activeCount > 0 ? `${activeCount}개 활동중` : '-';
}

function renderRanking(data, viewType = 'amount') {
  const container = document.getElementById('rankListContainer');

  const items = Object.entries(data).map(([symbol, info]) => ({
    symbol,
    name: info.name,
    sector: info.sector,
    ttm: getTTMBuyback(info.quarters),
    shares: getLatestShares(info.quarters),
  })).filter(d => d.ttm > 0);

  items.sort((a, b) => b.ttm - a.ttm);
  const top30 = items.slice(0, 30);
  const maxVal = top30[0]?.ttm || 1;

  let html = '<div class="rank-list">';
  top30.forEach((item, i) => {
    const pct = (item.ttm / maxVal * 100).toFixed(1);
    const color = getSectorColor(item.sector);
    html += `
      <div class="rank-item">
        <div class="rank-num">${i + 1}</div>
        <div class="rank-ticker">${item.symbol}</div>
        <div class="rank-bar-wrap">
          <div class="rank-bar" style="width:${pct}%;background:${color}"></div>
          <div class="rank-bar-label">${item.name?.substring(0, 20) || ''}</div>
        </div>
        <div class="rank-amount">${formatBillions(item.ttm)}</div>
      </div>`;
  });
  html += '</div>';

  // Add sector legend
  const sectorsUsed = [...new Set(top30.map(d => d.sector))].filter(Boolean);
  html += '<div class="sector-legend">';
  sectorsUsed.forEach(s => {
    html += `<div class="legend-item"><div class="legend-dot" style="background:${getSectorColor(s)}"></div>${getSectorKo(s)}</div>`;
  });
  html += '</div>';

  container.innerHTML = html;
}

function renderTrendChart(data) {
  const agg = getQuarterlyAggregates(data);
  const labels = Object.keys(agg).sort();
  // Show last 20 quarters max (5 years)
  const recent = labels.slice(-20);
  const values = recent.map(q => agg[q].total / 1e9);

  const ctx = document.getElementById('trendChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: recent,
      datasets: [{
        label: '자사주 매입 총액 ($B)',
        data: values,
        backgroundColor: values.map(v => {
          const max = Math.max(...values);
          const ratio = v / max;
          return `rgba(0, 212, 170, ${0.3 + ratio * 0.7})`;
        }),
        borderColor: 'rgba(0, 212, 170, 0.8)',
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: window.innerWidth < 640 ? 1.2 : 2,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1a28',
          titleColor: '#e8e8f0',
          bodyColor: '#e8e8f0',
          borderColor: '#2a2a40',
          borderWidth: 1,
          callbacks: {
            label: ctx => `$${ctx.parsed.y.toFixed(1)}B`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#55556a', font: { size: 10, family: 'JetBrains Mono' }, maxRotation: 45 },
          grid: { color: '#1e1e30' }
        },
        y: {
          ticks: {
            color: '#55556a',
            font: { size: 10, family: 'JetBrains Mono' },
            callback: v => `$${v}B`
          },
          grid: { color: '#1e1e30' }
        }
      }
    }
  });
}

function renderSectorChart(data) {
  const agg = getQuarterlyAggregates(data);
  const labels = Object.keys(agg).sort().slice(-12);

  // Get all sectors
  const allSectors = new Set();
  labels.forEach(q => Object.keys(agg[q].bySector).forEach(s => allSectors.add(s)));
  const sectors = [...allSectors].sort();

  const datasets = sectors.map(sector => ({
    label: getSectorKo(sector),
    data: labels.map(q => (agg[q].bySector[sector] || 0) / 1e9),
    backgroundColor: getSectorColor(sector) + 'cc',
    borderColor: getSectorColor(sector),
    borderWidth: 1,
  }));

  const ctx = document.getElementById('sectorChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: window.innerWidth < 640 ? 1 : 2,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#8888a8', font: { size: 10 }, boxWidth: 12, padding: 10, usePointStyle: true }
        },
        tooltip: {
          backgroundColor: '#1a1a28',
          titleColor: '#e8e8f0',
          bodyColor: '#e8e8f0',
          borderColor: '#2a2a40',
          borderWidth: 1,
          callbacks: { label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(1)}B` }
        }
      },
      scales: {
        x: {
          stacked: true,
          ticks: { color: '#55556a', font: { size: 10, family: 'JetBrains Mono' }, maxRotation: 45 },
          grid: { display: false }
        },
        y: {
          stacked: true,
          ticks: {
            color: '#55556a',
            font: { size: 10, family: 'JetBrains Mono' },
            callback: v => `$${v}B`
          },
          grid: { color: '#1e1e30' }
        }
      }
    }
  });
}

function renderYieldTable(data) {
  // Approximate buyback yield using TTM buyback / (shares * last known share price)
  // Since we don't have price, we'll rank by absolute TTM per share as proxy
  const items = Object.entries(data).map(([symbol, info]) => {
    const ttm = getTTMBuyback(info.quarters);
    const shares = getLatestShares(info.quarters);
    // Use TTM buyback relative to shares as a proxy for yield
    const yieldProxy = shares > 0 ? (ttm / shares) : 0;
    return { symbol, name: info.name, sector: info.sector, ttm, shares, yieldProxy };
  }).filter(d => d.ttm > 0 && d.yieldProxy > 0);

  items.sort((a, b) => b.yieldProxy - a.yieldProxy);
  const top20 = items.slice(0, 20);

  const tbody = document.getElementById('yieldBody');
  tbody.innerHTML = top20.map((item, i) => `
    <tr>
      <td class="mono" style="color:var(--text-muted)">${i + 1}</td>
      <td><span class="mono" style="color:var(--accent-blue);font-weight:600">${item.symbol}</span></td>
      <td style="font-size:12px;color:var(--text-secondary)">${item.name?.substring(0, 25) || '-'}</td>
      <td><span class="yield-sector">${getSectorKo(item.sector)}</span></td>
      <td class="yield-val yield-positive mono">$${item.yieldProxy.toFixed(2)}/주</td>
      <td class="mono" style="color:var(--text-primary)">${formatBillions(item.ttm)}</td>
    </tr>
  `).join('');
}

function renderBreadthChart(data) {
  const agg = getQuarterlyAggregates(data);
  const labels = Object.keys(agg).sort().slice(-16);

  const ctx = document.getElementById('breadthChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: '대규모 매입 (>$1B)',
          data: labels.map(q => agg[q].companies.heavy),
          backgroundColor: '#00d4aacc',
          borderColor: '#00d4aa',
          borderWidth: 1,
        },
        {
          label: '중간 매입 ($100M-$1B)',
          data: labels.map(q => agg[q].companies.medium),
          backgroundColor: '#4a90ffcc',
          borderColor: '#4a90ff',
          borderWidth: 1,
        },
        {
          label: '소규모 매입 (<$100M)',
          data: labels.map(q => agg[q].companies.light),
          backgroundColor: '#a855f7cc',
          borderColor: '#a855f7',
          borderWidth: 1,
        },
        {
          label: '매입 없음',
          data: labels.map(q => agg[q].companies.none),
          backgroundColor: '#2a2a3a',
          borderColor: '#3a3a4a',
          borderWidth: 1,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: window.innerWidth < 640 ? 1.2 : 2,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#8888a8', font: { size: 10 }, boxWidth: 12, padding: 10, usePointStyle: true }
        },
        tooltip: {
          backgroundColor: '#1a1a28',
          titleColor: '#e8e8f0',
          bodyColor: '#e8e8f0',
          borderColor: '#2a2a40',
          borderWidth: 1,
          callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}개사` }
        }
      },
      scales: {
        x: {
          stacked: true,
          ticks: { color: '#55556a', font: { size: 10, family: 'JetBrains Mono' }, maxRotation: 45 },
          grid: { display: false }
        },
        y: {
          stacked: true,
          ticks: {
            color: '#55556a',
            font: { size: 10, family: 'JetBrains Mono' },
            callback: v => `${v}개`
          },
          grid: { color: '#1e1e30' }
        }
      }
    }
  });
}

// ============================================
// TAB HANDLING
// ============================================
function setupTabs(data) {
  document.querySelectorAll('#rankTabs .tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#rankTabs .tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderRanking(data, btn.dataset.view);
    });
  });
}

// ============================================
// INIT
// ============================================
async function init() {
  try {
    const resp = await fetch(DATA_URL);
    if (!resp.ok) throw new Error('Data not found');
    const raw = await resp.json();

    const data = raw.data || {};
    const totalTickers = raw.sp500_list?.length || 500;
    const collectedTickers = Object.keys(data).length;

    // Update header info
    document.getElementById('lastUpdate').textContent = raw.last_updated?.substring(0, 10) || '-';
    document.getElementById('coverage').textContent = `${collectedTickers}/${totalTickers}개`;

    if (collectedTickers < 10) {
      document.getElementById('rankListContainer').innerHTML =
        '<div class="data-status">아직 충분한 데이터가 수집되지 않았습니다.<br>매일 50개 종목씩 수집중입니다. (현재 ' + collectedTickers + '개)</div>';
      return;
    }

    renderStats(data);
    renderRanking(data, 'amount');
    renderTrendChart(data);
    renderSectorChart(data);
    renderYieldTable(data);
    renderBreadthChart(data);
    setupTabs(data);

  } catch (e) {
    console.error('Failed to load data:', e);
    document.getElementById('rankListContainer').innerHTML =
      '<div class="data-status">데이터를 불러올 수 없습니다.<br>buyback_data.json 파일을 확인해주세요.</div>';
  }
}

init();
</script>
</body>
</html>
