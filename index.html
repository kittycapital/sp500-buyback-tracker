<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>S&P 500 자사주 매입 트래커</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js"></script>
<style>
:root {
  --bg: #000000;
  --surface: #0a0a0a;
  --surface2: #111111;
  --border: #1a1a1a;
  --border-hover: #2a2a2a;
  --text: #e4e4e7;
  --text-dim: #71717a;
  --text-muted: #52525b;
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.12);
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.12);
  --cyan: #22d3ee;
  --accent-blue: #4a90ff;
  --accent-purple: #a855f7;
  --accent-orange: #ff8c42;
  --accent-yellow: #ffd644;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Noto Sans KR', -apple-system, sans-serif;
  --radius: 12px;
  --radius-sm: 8px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { -webkit-text-size-adjust: 100%; scrollbar-width: none; }
html::-webkit-scrollbar { display: none; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  line-height: 1.6;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  -webkit-font-smoothing: antialiased;
}

.mono { font-family: var(--mono); }

/* ====== HEADER ====== */
.header {
  padding: 36px 20px 24px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}

.header h1 {
  font-size: clamp(22px, 5vw, 36px);
  font-weight: 800;
  color: #fff;
  margin-bottom: 6px;
  line-height: 1.3;
  letter-spacing: -0.02em;
}

.header p { color: var(--text-dim); font-size: 13px; max-width: 500px; margin: 0 auto; }
.header-meta { margin-top: 8px; font-size: 11px; color: var(--text-muted); }

/* ====== STATS BAR ====== */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1px;
  background: var(--border);
  border-bottom: 1px solid var(--border);
}

.stat-item { background: var(--surface); padding: 14px 10px; text-align: center; }

.stat-value {
  font-family: var(--mono);
  font-size: clamp(16px, 4vw, 22px);
  font-weight: 700;
  color: var(--cyan);
  white-space: nowrap;
}

.stat-label {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-top: 2px;
  line-height: 1.3;
}

/* ====== SECTIONS ====== */
.section {
  padding: 28px 16px;
  border-bottom: 1px solid var(--border);
  max-width: 1100px;
  margin: 0 auto;
}

.section-header { margin-bottom: 20px; text-align: center; }

.section-num {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--cyan);
  letter-spacing: 2px;
  display: block;
  margin-bottom: 4px;
}

.section-title {
  font-size: clamp(17px, 3.5vw, 24px);
  font-weight: 800;
  color: #fff;
  margin-bottom: 4px;
  line-height: 1.3;
}

.section-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; }

/* ====== CHART CONTAINERS ====== */
.chart-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 10px;
  margin-bottom: 16px;
  position: relative;
}

.chart-wrap canvas { width: 100% !important; max-height: 400px; }

/* Watermark */
.chart-wrap::after {
  content: 'Herdvibe.com';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--mono);
  font-size: 28px;
  font-weight: 600;
  color: rgba(255,255,255,0.04);
  pointer-events: none;
  z-index: 2;
  letter-spacing: 2px;
  white-space: nowrap;
}

/* ====== DETAIL CHART (COMPANY) ====== */
.detail-chart-area {
  margin-bottom: 16px;
  display: none;
}

.detail-chart-area.active { display: block; }

.detail-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.detail-ticker {
  font-family: var(--mono);
  font-size: clamp(18px, 4vw, 24px);
  font-weight: 700;
  color: var(--accent-blue);
}

.detail-name {
  font-size: clamp(12px, 2.5vw, 14px);
  color: var(--text-dim);
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.detail-sector {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 4px;
  color: #000;
  font-weight: 600;
}

.detail-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 14px;
}

.detail-stat {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 8px 6px;
  text-align: center;
}

.detail-stat-val {
  font-family: var(--mono);
  font-size: clamp(13px, 3vw, 16px);
  font-weight: 600;
  color: var(--cyan);
}

.detail-stat-lbl {
  font-size: 9px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-top: 2px;
}

.detail-legend {
  display: flex;
  gap: 12px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.detail-legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  color: var(--text-dim);
}

.detail-legend-dot {
  width: 10px;
  height: 3px;
  border-radius: 2px;
  flex-shrink: 0;
}

.detail-legend-bar {
  width: 10px;
  height: 10px;
  border-radius: 2px;
  flex-shrink: 0;
}

/* ====== RANKING ====== */
.rank-list { display: flex; flex-direction: column; gap: 4px; }

.rank-item {
  display: grid;
  grid-template-columns: 26px 54px 1fr 72px;
  align-items: center;
  gap: 6px;
  padding: 7px 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.rank-item:active, .rank-item:hover { background: var(--surface2); }
.rank-item.selected {
  border-color: var(--cyan);
  background: rgba(34, 211, 238, 0.06);
}

.rank-num { font-family: var(--mono); font-size: 11px; color: var(--text-muted); text-align: center; }
.rank-ticker { font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--accent-blue); overflow: hidden; text-overflow: ellipsis; }

.rank-bar-wrap { height: 20px; background: var(--surface2); border-radius: 3px; overflow: hidden; position: relative; }
.rank-bar { height: 100%; border-radius: 3px; transition: width 0.8s ease; min-width: 2px; }
.rank-bar-label { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 9px; font-family: var(--mono); color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
.rank-amount { font-family: var(--mono); font-size: 11px; color: var(--text); text-align: right; white-space: nowrap; }

/* ====== SECTOR LEGEND ====== */
.sector-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
.legend-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-dim); }
.legend-dot { width: 7px; height: 7px; border-radius: 2px; flex-shrink: 0; }

/* ====== YIELD TABLE ====== */
.table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -10px; padding: 0 10px; }
.yield-table { width: 100%; border-collapse: collapse; min-width: 480px; }
.yield-table th { text-align: left; font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; padding: 8px 8px; border-bottom: 1px solid var(--border); white-space: nowrap; position: sticky; top: 0; background: var(--surface); }
.yield-table td { padding: 8px 8px; font-size: 12px; border-bottom: 1px solid var(--border); }
.yield-table tr:active { background: var(--surface2); }
.yield-val { font-family: var(--mono); font-weight: 600; }
.yield-positive { color: var(--cyan); }
.yield-sector { font-size: 10px; padding: 2px 6px; border-radius: 3px; background: var(--surface2); color: var(--text-dim); white-space: nowrap; }

/* ====== BREADTH ====== */
.breadth-legend { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
.breadth-legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-dim); }
.breadth-legend-dot { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }

/* ====== STATUS ====== */
.data-status { text-align: center; padding: 48px 16px; color: var(--text-muted); font-size: 13px; }
.data-status .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--cyan); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 14px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ====== TABS ====== */
.tab-bar { display: flex; gap: 4px; margin-bottom: 16px; justify-content: center; }
.tab-btn { padding: 6px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: transparent; color: var(--text-dim); font-size: 12px; font-family: var(--sans); cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
.tab-btn:active { background: var(--surface2); }
.tab-btn.active { background: var(--cyan); color: #000; border-color: var(--cyan); font-weight: 600; }

/* ====== SHARE ====== */
.share-bar{display:flex;gap:6px;justify-content:center;margin:12px 0 4px;flex-wrap:wrap}
.share-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;border:1px solid var(--border-hover);background:var(--surface);color:#a1a1aa;font-size:11px;cursor:pointer;font-family:var(--sans);transition:all 0.2s}
.share-btn:hover{border-color:#444;color:var(--text)}
.share-btn svg{width:14px;height:14px;flex-shrink:0}
.share-btn.twitter:hover{border-color:#1d9bf0;color:#1d9bf0}
.share-btn.kakao:hover{border-color:#fee500;color:#fee500}
.share-btn.telegram:hover{border-color:#26a5e4;color:#26a5e4}
.share-btn.instagram:hover{border-color:#e1306c;color:#e1306c}
.share-btn.instagram.copied{border-color:var(--green);color:var(--green)}
.share-btn.copy:hover{border-color:var(--green);color:var(--green)}
.share-btn.copied{border-color:var(--green);color:var(--green)}

/* ====== TOAST ====== */
.toast{position:fixed;bottom:20px;right:20px;background:var(--green);color:#000;padding:10px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;z-index:9999;opacity:0;transform:translateY(10px);transition:all 0.3s ease;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}

/* ====== FOOTER ====== */
.footer { text-align: center; padding: 24px 16px 8px; font-size: 10px; color: var(--text-muted); line-height: 1.6; }

/* ====== DESKTOP ====== */
@media (min-width: 641px) {
  .header { padding: 48px 24px 32px; }
  .header p { font-size: 14px; }
  .stats-bar { grid-template-columns: repeat(4, 1fr); }
  .stat-item { padding: 20px 16px; }
  .stat-label { font-size: 11px; }
  .section { padding: 40px 24px; }
  .section-header { margin-bottom: 28px; }
  .section-desc { font-size: 13px; }
  .chart-wrap { padding: 24px 16px; }
  .rank-item { grid-template-columns: 32px 70px 1fr 100px; gap: 10px; padding: 8px 12px; }
  .rank-ticker { font-size: 13px; }
  .rank-num { font-size: 12px; }
  .rank-bar-wrap { height: 22px; }
  .rank-bar-label { font-size: 10px; }
  .rank-amount { font-size: 12px; }
  .yield-table th { font-size: 10px; padding: 10px 12px; }
  .yield-table td { padding: 10px 12px; font-size: 13px; }
  .yield-table tr:hover { background: var(--surface2); }
  .breadth-legend { grid-template-columns: repeat(4, auto); gap: 16px; }
  .footer { font-size: 11px; padding: 32px 20px 8px; }
}

/* ====== NARROW ====== */
@media (max-width: 400px) {
  .header { padding: 24px 12px 18px; }
  .header h1 { font-size: 20px; }
  .header p { font-size: 11px; }
  .stat-item { padding: 10px 6px; }
  .stat-value { font-size: 15px; }
  .stat-label { font-size: 9px; }
  .section { padding: 20px 10px; }
  .section-title { font-size: 16px; }
  .section-desc { font-size: 11px; }
  .chart-wrap { padding: 10px 6px; }
  .chart-wrap::after { font-size: 20px; }
  .rank-item { grid-template-columns: 22px 48px 1fr 60px; gap: 4px; padding: 5px 6px; }
  .rank-num { font-size: 10px; }
  .rank-ticker { font-size: 11px; }
  .rank-bar-wrap { height: 16px; }
  .rank-bar-label { font-size: 8px; }
  .rank-amount { font-size: 10px; }
  .breadth-legend { grid-template-columns: 1fr; gap: 4px; }
  .breadth-legend-item { font-size: 10px; }
  .detail-stats { grid-template-columns: repeat(3, 1fr); gap: 4px; }
  .detail-stat { padding: 6px 4px; }
}
</style>
</head>
<body>

<div class="header">
  <h1>자사주 매입 트래커</h1>
  <p>S&P 500 기업들의 자사주 매입 현황을 추적합니다</p>
  <div class="header-meta">업데이트: <span id="lastUpdate" class="mono">-</span> · 수집: <span id="coverage" class="mono">-</span></div>
</div>

<div class="stats-bar">
  <div class="stat-item"><div class="stat-value" id="statTotalBuyback">-</div><div class="stat-label">총 매입 규모 (TTM)</div></div>
  <div class="stat-item"><div class="stat-value" id="statActiveCount">-</div><div class="stat-label">매입 활동 기업 수</div></div>
  <div class="stat-item"><div class="stat-value" id="statTopSector">-</div><div class="stat-label">최대 매입 섹터</div></div>
  <div class="stat-item"><div class="stat-value" id="statAvgYield">-</div><div class="stat-label">평균 매입 수익률</div></div>
</div>

<!-- Section 1: Ranking + Detail Chart -->
<div class="section" id="sec1">
  <div class="section-header">
    <span class="section-num">01</span>
    <div class="section-title">자사주 매입 규모 랭킹</div>
    <div class="section-desc">종목을 클릭하면 분기별 매입 현황을 확인할 수 있습니다</div>
  </div>

  <div class="detail-chart-area" id="detailArea">
    <div class="chart-wrap">
      <div class="detail-header">
        <span class="detail-ticker" id="detailTicker">-</span>
        <span class="detail-name" id="detailName">-</span>
        <span class="detail-sector" id="detailSector">-</span>
      </div>
      <div class="detail-stats">
        <div class="detail-stat">
          <div class="detail-stat-val" id="detailTTM">-</div>
          <div class="detail-stat-lbl">TTM 매입액</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-val" id="detailShares">-</div>
          <div class="detail-stat-lbl">주식수 변화</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-val" id="detailPrice">-</div>
          <div class="detail-stat-lbl">현재 주가</div>
        </div>
      </div>
      <canvas id="detailChart"></canvas>
      <div class="detail-legend">
        <div class="detail-legend-item"><div class="detail-legend-bar" style="background:var(--cyan)"></div>매입 금액</div>
        <div class="detail-legend-item"><div class="detail-legend-dot" style="background:var(--accent-blue);height:3px"></div>주식수</div>
        <div class="detail-legend-item"><div class="detail-legend-dot" style="background:var(--accent-orange);height:3px"></div>주가</div>
      </div>
    </div>
  </div>

  <div class="tab-bar" id="rankTabs">
    <button class="tab-btn active" data-view="amount">매입 금액</button>
    <button class="tab-btn" data-view="yield">매입 수익률</button>
  </div>
  <div id="rankListContainer">
    <div class="data-status"><div class="spinner"></div>데이터 로딩중...</div>
  </div>
</div>

<!-- Section 2 -->
<div class="section" id="sec2">
  <div class="section-header">
    <span class="section-num">02</span>
    <div class="section-title">S&P 500 전체 자사주 매입 추이</div>
    <div class="section-desc">분기별 S&P 500 기업 전체의 자사주 매입 총액</div>
  </div>
  <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
</div>

<!-- Section 3 -->
<div class="section" id="sec3">
  <div class="section-header">
    <span class="section-num">03</span>
    <div class="section-title">섹터별 매입 비중</div>
    <div class="section-desc">GICS 섹터별 분기 자사주 매입 금액 비중</div>
  </div>
  <div class="chart-wrap"><canvas id="sectorChart"></canvas></div>
</div>

<!-- Section 4 -->
<div class="section" id="sec4">
  <div class="section-header">
    <span class="section-num">04</span>
    <div class="section-title">매입 수익률 TOP 20</div>
    <div class="section-desc">자사주 매입액 / 시가총액 기준 상위 기업</div>
  </div>
  <div class="chart-wrap">
    <div class="table-scroll">
      <table class="yield-table" id="yieldTable">
        <thead><tr><th>#</th><th>티커</th><th>기업명</th><th>섹터</th><th>수익률</th><th>매입액</th></tr></thead>
        <tbody id="yieldBody"><tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:32px">데이터 로딩중...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Section 5 -->
<div class="section" id="sec5">
  <div class="section-header">
    <span class="section-num">05</span>
    <div class="section-title">매입 기업 수 추이</div>
    <div class="section-desc">분기별 자사주 매입 활동 기업 수 (매입 강도별)</div>
  </div>
  <div class="breadth-legend">
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:var(--cyan)"></div>대규모 (>$1B)</div>
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:var(--accent-blue)"></div>중간 매입</div>
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:var(--accent-purple)"></div>소규모 매입</div>
    <div class="breadth-legend-item"><div class="breadth-legend-dot" style="background:#2a2a3a"></div>매입 없음</div>
  </div>
  <div class="chart-wrap"><canvas id="breadthChart"></canvas></div>
</div>

<div class="footer">
  데이터 출처: Yahoo Finance (yfinance) · 매일 50개 종목 업데이트 (10일 주기 순환)<br>
  자사주 매입 데이터는 분기 재무제표 기반이며, 실시간 매입 집행 내역과 다를 수 있습니다.
</div>

<!-- SHARE -->
<div class="share-bar">
    <button class="share-btn twitter" onclick="shareTwitter()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>트위터</button>
    <button class="share-btn kakao" onclick="shareKakao()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-5.52 0-10 3.36-10 7.5 0 2.66 1.74 5 4.36 6.33-.14.53-.9 3.4-.93 3.61 0 0-.02.17.09.23.11.07.24.03.24.03.32-.04 3.7-2.42 4.28-2.83.62.09 1.27.13 1.96.13 5.52 0 10-3.36 10-7.5S17.52 3 12 3z"/></svg>카카오톡</button>
    <button class="share-btn telegram" onclick="shareTelegram()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>텔레그램</button>
    <button class="share-btn instagram" onclick="shareInstagram(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>인스타그램</button>
    <button class="share-btn copy" onclick="copyLink(this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>링크복사</button>
</div>

<div style="height:24px"></div>

<div class="toast" id="toast"></div>

<script>
// ============================================
// SHARE
// ============================================
const SHARE_URL = 'https://herdvibe.com/buyback-tracker';
const SHARE_TITLE = 'S&P 500 자사주 매입 트래커 — Herdvibe';
const SHARE_DESC = 'S&P 500 기업들의 자사주 매입 현황 분석 | Herdvibe';

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}
function shareTwitter() {
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(SHARE_TITLE)}&url=${encodeURIComponent(SHARE_URL)}`, '_blank');
}
function shareKakao() {
    if (window.Kakao && !Kakao.isInitialized()) Kakao.init('a43ed7b39fac35458f4f9df925a279b5');
    if (window.Kakao) {
        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: { title: SHARE_TITLE, description: SHARE_DESC, imageUrl: 'https://herdvibe.com/og-buyback.png', link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL } }
        });
    }
}
function shareTelegram() {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_URL)}&text=${encodeURIComponent(SHARE_TITLE)}`, '_blank');
}
function shareInstagram(btn) {
    try {
        if (window.parent !== window) { window.parent.postMessage({ type: 'copy', text: SHARE_URL }, '*'); }
        else { navigator.clipboard.writeText(SHARE_URL); }
        const orig = btn.innerHTML;
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>복사됨!';
        showToast('링크가 복사되었습니다 - 인스타그램에 붙여넣기 하세요 ✓');
        setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = orig; }, 2000);
    } catch(e) { showToast('복사 실패'); }
}
function copyLink(btn) {
    try {
        if (window.parent !== window) { window.parent.postMessage({ type: 'copy', text: SHARE_URL }, '*'); }
        else { navigator.clipboard.writeText(SHARE_URL); }
        const orig = btn.innerHTML;
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>복사됨!';
        showToast('링크가 복사되었습니다 ✓');
        setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = orig; }, 2000);
    } catch(e) { showToast('복사 실패'); }
}

// ============================================
// CONFIG
// ============================================
const DATA_URL = 'buyback_data.json';
const IS_MOBILE = window.innerWidth < 641;
const IS_NARROW = window.innerWidth < 401;

let GLOBAL_DATA = null;
let detailChartInstance = null;
let selectedSymbol = null;

const SECTOR_COLORS = {
  'Technology':'#4a90ff','Information Technology':'#4a90ff',
  'Financial Services':'#22c55e','Financials':'#22c55e',
  'Healthcare':'#ff4d6a','Health Care':'#ff4d6a',
  'Consumer Cyclical':'#ff8c42','Consumer Discretionary':'#ff8c42',
  'Consumer Defensive':'#a855f7','Consumer Staples':'#a855f7',
  'Energy':'#ffd644','Industrials':'#00d4aa',
  'Basic Materials':'#e879a0','Materials':'#e879a0',
  'Real Estate':'#64748b','Utilities':'#818cf8',
  'Communication Services':'#f97316',
};

const SECTOR_KO = {
  'Technology':'기술','Information Technology':'기술',
  'Financial Services':'금융','Financials':'금융',
  'Healthcare':'헬스케어','Health Care':'헬스케어',
  'Consumer Cyclical':'경기소비재','Consumer Discretionary':'경기소비재',
  'Consumer Defensive':'필수소비재','Consumer Staples':'필수소비재',
  'Energy':'에너지','Industrials':'산업재',
  'Basic Materials':'소재','Materials':'소재',
  'Real Estate':'부동산','Utilities':'유틸리티',
  'Communication Services':'커뮤니케이션',
};

function getSectorColor(s) { return SECTOR_COLORS[s] || '#666'; }
function getSectorKo(s) { return SECTOR_KO[s] || s; }
function formatB(v) {
  const a = Math.abs(v);
  if (a >= 1e12) return `$${(a/1e12).toFixed(1)}T`;
  if (a >= 1e9) return `$${(a/1e9).toFixed(1)}B`;
  if (a >= 1e6) return `$${(a/1e6).toFixed(0)}M`;
  return `$${a.toLocaleString()}`;
}

// ============================================
// DATA PROCESSING
// ============================================
function getTTMBuyback(q) {
  const s = [...q].sort((a,b) => b.date.localeCompare(a.date));
  return s.slice(0,4).reduce((t,x) => t + Math.abs(Math.min(x.buyback_amount,0)), 0);
}

function getQuarterLabel(d) {
  const dt = new Date(d);
  return `${dt.getFullYear()} Q${Math.ceil((dt.getMonth()+1)/3)}`;
}

function getQuarterlyAggregates(data) {
  const q = {};
  Object.entries(data).forEach(([,info]) => {
    info.quarters.forEach(x => {
      const l = getQuarterLabel(x.date);
      if (!q[l]) q[l] = { total:0, bySector:{}, companies:{heavy:0,medium:0,light:0,none:0} };
      const bb = Math.abs(Math.min(x.buyback_amount,0));
      q[l].total += bb;
      const sec = info.sector||'Unknown';
      q[l].bySector[sec] = (q[l].bySector[sec]||0) + bb;
      if (bb > 1e9) q[l].companies.heavy++;
      else if (bb > 1e8) q[l].companies.medium++;
      else if (bb > 0) q[l].companies.light++;
      else q[l].companies.none++;
    });
  });
  return q;
}

// ============================================
// CHART DEFAULTS
// ============================================
function chartDefaults() {
  return {
    responsive: true,
    maintainAspectRatio: true,
    aspectRatio: IS_NARROW ? 1 : IS_MOBILE ? 1.3 : 2,
    interaction: { mode:'index', intersect:false },
    plugins: {
      tooltip: {
        backgroundColor:'#111', titleColor:'#e4e4e7', bodyColor:'#e4e4e7',
        borderColor:'#2a2a2a', borderWidth:1,
        titleFont:{ size: IS_MOBILE?11:12 }, bodyFont:{ size: IS_MOBILE?11:12 },
        padding: IS_MOBILE?8:10,
      }
    },
    scales: {
      x: {
        ticks: {
          color:'#52525b',
          font:{ size: IS_NARROW?8:IS_MOBILE?9:10, family:'JetBrains Mono' },
          maxRotation: IS_MOBILE?60:45, autoSkip:true,
          maxTicksLimit: IS_NARROW?6:IS_MOBILE?8:20,
        },
        grid:{ color:'#1a1a1a', display:false }
      },
      y: {
        ticks: {
          color:'#52525b',
          font:{ size: IS_NARROW?8:IS_MOBILE?9:10, family:'JetBrains Mono' },
          maxTicksLimit: IS_MOBILE?5:8,
        },
        grid:{ color:'#1a1a1a' }
      }
    }
  };
}

// ============================================
// COMPANY DETAIL CHART
// ============================================
function showDetailChart(symbol) {
  const info = GLOBAL_DATA[symbol];
  if (!info) return;

  selectedSymbol = symbol;
  const area = document.getElementById('detailArea');
  area.classList.add('active');

  document.getElementById('detailTicker').textContent = symbol;
  document.getElementById('detailName').textContent = info.name || '';
  const sectorEl = document.getElementById('detailSector');
  sectorEl.textContent = getSectorKo(info.sector);
  sectorEl.style.background = getSectorColor(info.sector);

  const ttm = getTTMBuyback(info.quarters);
  document.getElementById('detailTTM').textContent = formatB(ttm);

  const sorted = [...info.quarters].sort((a,b) => b.date.localeCompare(a.date));
  const latestShares = sorted[0]?.shares_outstanding || 0;
  const oldestShares = sorted[sorted.length-1]?.shares_outstanding || 0;
  const sharesChange = oldestShares > 0 ? ((latestShares - oldestShares) / oldestShares * 100) : 0;
  document.getElementById('detailShares').textContent = sharesChange !== 0 ? `${sharesChange > 0 ? '+' : ''}${sharesChange.toFixed(1)}%` : '-';
  document.getElementById('detailShares').style.color = sharesChange < 0 ? 'var(--cyan)' : sharesChange > 0 ? 'var(--red)' : 'var(--text-muted)';

  const latestPrice = info.current_price || sorted[0]?.price || 0;
  document.getElementById('detailPrice').textContent = latestPrice > 0 ? `$${latestPrice.toFixed(0)}` : '-';

  const chronoQ = [...info.quarters].sort((a,b) => a.date.localeCompare(b.date));
  const labels = chronoQ.map(q => getQuarterLabel(q.date));
  const buybackVals = chronoQ.map(q => Math.abs(Math.min(q.buyback_amount, 0)) / 1e9);
  const sharesVals = chronoQ.map(q => q.shares_outstanding > 0 ? q.shares_outstanding / 1e9 : null);
  const priceVals = chronoQ.map(q => q.price > 0 ? q.price : null);

  if (detailChartInstance) detailChartInstance.destroy();

  const ctx = document.getElementById('detailChart').getContext('2d');
  const datasets = [
    {
      label: '매입 금액 ($B)',
      type: 'bar',
      data: buybackVals,
      backgroundColor: 'rgba(34, 211, 238, 0.7)',
      borderColor: '#22d3ee',
      borderWidth: 1,
      borderRadius: 3,
      yAxisID: 'y',
      order: 2,
    }
  ];

  const scales = {
    x: {
      ticks: {
        color:'#52525b',
        font:{ size: IS_NARROW?7:IS_MOBILE?8:10, family:'JetBrains Mono' },
        maxRotation:60, autoSkip:true,
        maxTicksLimit: IS_NARROW?5:IS_MOBILE?6:12,
      },
      grid:{ display:false }
    },
    y: {
      position: 'left',
      title: { display: !IS_NARROW, text: '매입 금액 ($B)', color:'#22d3ee', font:{ size:10 } },
      ticks: { color:'#52525b', font:{ size: IS_MOBILE?8:10, family:'JetBrains Mono' }, callback: v => `$${v.toFixed(1)}B` },
      grid:{ color:'#1a1a1a' },
    }
  };

  const hasShares = sharesVals.some(v => v !== null && v > 0);
  if (hasShares) {
    datasets.push({
      label: '주식수 (B)',
      type: 'line',
      data: sharesVals,
      borderColor: '#4a90ff',
      backgroundColor: 'rgba(74,144,255,0.1)',
      borderWidth: 2,
      pointRadius: IS_MOBILE ? 1 : 2,
      pointHoverRadius: 4,
      tension: 0.3,
      yAxisID: 'y1',
      order: 1,
    });
    scales.y1 = {
      position: 'right',
      title: { display: !IS_NARROW, text: '주식수 (B)', color:'#4a90ff', font:{ size:10 } },
      ticks: { color:'#52525b', font:{ size: IS_MOBILE?8:10, family:'JetBrains Mono' }, callback: v => `${v.toFixed(1)}B` },
      grid:{ display:false },
    };
  }

  const hasPrice = priceVals.some(v => v !== null && v > 0);
  if (hasPrice) {
    const priceAxisId = hasShares ? 'y2' : 'y1';
    datasets.push({
      label: '주가 ($)',
      type: 'line',
      data: priceVals,
      borderColor: '#ff8c42',
      backgroundColor: 'rgba(255,140,66,0.1)',
      borderWidth: 2,
      borderDash: [4, 2],
      pointRadius: IS_MOBILE ? 0 : 2,
      pointHoverRadius: 4,
      tension: 0.3,
      yAxisID: priceAxisId,
      order: 0,
    });
    if (!hasShares) {
      scales.y1 = {
        position: 'right',
        title: { display: !IS_NARROW, text: '주가 ($)', color:'#ff8c42', font:{ size:10 } },
        ticks: { color:'#52525b', font:{ size: IS_MOBILE?8:10, family:'JetBrains Mono' }, callback: v => `$${v}` },
        grid:{ display:false },
      };
    } else {
      scales.y2 = {
        position: 'right',
        title: { display: false },
        ticks: { color:'#52525b', font:{ size: IS_MOBILE?8:9, family:'JetBrains Mono' }, callback: v => `$${v}`, maxTicksLimit: 4 },
        grid:{ display:false },
      };
    }
  }

  detailChartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: IS_NARROW ? 1.1 : IS_MOBILE ? 1.4 : 2.2,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor:'#111', titleColor:'#e4e4e7', bodyColor:'#e4e4e7',
          borderColor:'#2a2a2a', borderWidth:1,
          titleFont:{ size:11 }, bodyFont:{ size:11 }, padding:8,
          callbacks: {
            label: function(ctx) {
              const lbl = ctx.dataset.label;
              if (lbl.includes('매입')) return `매입: $${ctx.parsed.y.toFixed(2)}B`;
              if (lbl.includes('주식')) return `주식수: ${ctx.parsed.y.toFixed(2)}B`;
              if (lbl.includes('주가')) return `주가: $${ctx.parsed.y.toFixed(2)}`;
              return `${lbl}: ${ctx.parsed.y}`;
            }
          }
        }
      },
      scales
    }
  });

  document.querySelectorAll('.rank-item').forEach(el => {
    el.classList.toggle('selected', el.dataset.symbol === symbol);
  });

  area.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ============================================
// RENDERING
// ============================================
function renderStats(data) {
  let totalTTM = 0, activeCount = 0;
  const sectorTotals = {};
  Object.values(data).forEach(info => {
    const ttm = getTTMBuyback(info.quarters);
    totalTTM += ttm;
    if (ttm > 0) activeCount++;
    const sec = info.sector||'Unknown';
    sectorTotals[sec] = (sectorTotals[sec]||0) + ttm;
  });
  document.getElementById('statTotalBuyback').textContent = formatB(totalTTM);
  document.getElementById('statActiveCount').textContent = `${activeCount}개`;
  const top = Object.entries(sectorTotals).sort((a,b) => b[1]-a[1])[0];
  document.getElementById('statTopSector').textContent = top ? getSectorKo(top[0]) : '-';
  document.getElementById('statAvgYield').textContent = activeCount > 0 ? `${activeCount}개 활동중` : '-';
}

function renderRanking(data, viewType) {
  const container = document.getElementById('rankListContainer');
  const items = Object.entries(data).map(([symbol, info]) => ({
    symbol, name: info.name, sector: info.sector,
    ttm: getTTMBuyback(info.quarters),
    marketCap: info.market_cap || 0,
  })).filter(d => d.ttm > 0);

  if (viewType === 'yield') {
    items.forEach(d => d.yieldPct = d.marketCap > 0 ? (d.ttm / d.marketCap * 100) : 0);
    items.sort((a,b) => b.yieldPct - a.yieldPct);
  } else {
    items.sort((a,b) => b.ttm - a.ttm);
  }

  const top30 = items.slice(0, 30);
  const maxVal = viewType === 'yield' ? (top30[0]?.yieldPct||1) : (top30[0]?.ttm||1);
  const nameLen = IS_NARROW ? 10 : IS_MOBILE ? 14 : 20;

  let html = '<div class="rank-list">';
  top30.forEach((item, i) => {
    const val = viewType === 'yield' ? item.yieldPct : item.ttm;
    const pct = (val / maxVal * 100).toFixed(1);
    const color = getSectorColor(item.sector);
    const display = viewType === 'yield' ? `${item.yieldPct.toFixed(1)}%` : formatB(item.ttm);
    const sel = item.symbol === selectedSymbol ? ' selected' : '';
    html += `
      <div class="rank-item${sel}" data-symbol="${item.symbol}" onclick="showDetailChart('${item.symbol}')">
        <div class="rank-num">${i+1}</div>
        <div class="rank-ticker">${item.symbol}</div>
        <div class="rank-bar-wrap">
          <div class="rank-bar" style="width:${pct}%;background:${color}"></div>
          <div class="rank-bar-label">${item.name?.substring(0, nameLen)||''}</div>
        </div>
        <div class="rank-amount">${display}</div>
      </div>`;
  });
  html += '</div>';

  const secs = [...new Set(top30.map(d => d.sector))].filter(Boolean);
  html += '<div class="sector-legend">';
  secs.forEach(s => {
    html += `<div class="legend-item"><div class="legend-dot" style="background:${getSectorColor(s)}"></div>${getSectorKo(s)}</div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

function renderTrendChart(data) {
  const agg = getQuarterlyAggregates(data);
  const labels = Object.keys(agg).sort();
  const recent = labels.slice(IS_MOBILE ? -12 : -20);
  const values = recent.map(q => agg[q].total / 1e9);
  const opts = chartDefaults();
  opts.plugins.legend = { display:false };
  opts.plugins.tooltip.callbacks = { label: ctx => `$${ctx.parsed.y.toFixed(1)}B` };
  opts.scales.y.ticks.callback = v => `$${v}B`;

  new Chart(document.getElementById('trendChart').getContext('2d'), {
    type:'bar', data: {
      labels: recent,
      datasets: [{ label:'매입 총액', data:values,
        backgroundColor: values.map(v => { const r = v/Math.max(...values); return `rgba(34,211,238,${0.3+r*0.7})`; }),
        borderColor:'rgba(34,211,238,0.8)', borderWidth:1, borderRadius:3,
      }]
    }, options: opts
  });
}

function renderSectorChart(data) {
  const agg = getQuarterlyAggregates(data);
  const labels = Object.keys(agg).sort().slice(IS_MOBILE ? -8 : -12);
  const allSec = new Set();
  labels.forEach(q => Object.keys(agg[q].bySector).forEach(s => allSec.add(s)));
  const datasets = [...allSec].sort().map(sec => ({
    label: getSectorKo(sec),
    data: labels.map(q => (agg[q].bySector[sec]||0)/1e9),
    backgroundColor: getSectorColor(sec)+'cc', borderColor: getSectorColor(sec), borderWidth:1,
  }));
  const opts = chartDefaults();
  opts.scales.x.stacked = true; opts.scales.y.stacked = true;
  opts.scales.y.ticks.callback = v => `$${v}B`;
  opts.plugins.legend = { position:'bottom', labels:{ color:'#71717a', font:{ size: IS_MOBILE?9:10 }, boxWidth: IS_MOBILE?8:12, padding: IS_MOBILE?6:10, usePointStyle:true } };
  opts.plugins.tooltip.callbacks = { label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(1)}B` };

  new Chart(document.getElementById('sectorChart').getContext('2d'), {
    type:'bar', data:{ labels, datasets }, options:opts
  });
}

function renderYieldTable(data) {
  const items = Object.entries(data).map(([symbol, info]) => {
    const ttm = getTTMBuyback(info.quarters);
    const mc = info.market_cap||0;
    const yld = mc > 0 ? (ttm/mc*100) : 0;
    return { symbol, name:info.name, sector:info.sector, ttm, yld };
  }).filter(d => d.ttm > 0 && d.yld > 0);
  items.sort((a,b) => b.yld - a.yld);
  const nameLen = IS_NARROW ? 12 : IS_MOBILE ? 16 : 25;

  document.getElementById('yieldBody').innerHTML = items.slice(0,20).map((item,i) => `
    <tr>
      <td class="mono" style="color:var(--text-muted)">${i+1}</td>
      <td><span class="mono" style="color:var(--accent-blue);font-weight:600">${item.symbol}</span></td>
      <td style="font-size:11px;color:var(--text-dim)">${item.name?.substring(0,nameLen)||'-'}</td>
      <td><span class="yield-sector">${getSectorKo(item.sector)}</span></td>
      <td class="yield-val yield-positive mono">${item.yld.toFixed(2)}%</td>
      <td class="mono" style="color:var(--text)">${formatB(item.ttm)}</td>
    </tr>`).join('');
}

function renderBreadthChart(data) {
  const agg = getQuarterlyAggregates(data);
  const labels = Object.keys(agg).sort().slice(IS_MOBILE ? -10 : -16);
  const opts = chartDefaults();
  opts.scales.x.stacked = true; opts.scales.y.stacked = true;
  opts.scales.y.ticks.callback = v => `${v}개`;
  opts.plugins.legend = { display:false };
  opts.plugins.tooltip.callbacks = { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}개사` };

  new Chart(document.getElementById('breadthChart').getContext('2d'), {
    type:'bar', data: {
      labels,
      datasets: [
        { label:'대규모 (>$1B)', data:labels.map(q=>agg[q].companies.heavy), backgroundColor:'rgba(34,211,238,0.8)', borderColor:'#22d3ee', borderWidth:1 },
        { label:'중간 매입', data:labels.map(q=>agg[q].companies.medium), backgroundColor:'rgba(74,144,255,0.8)', borderColor:'#4a90ff', borderWidth:1 },
        { label:'소규모 매입', data:labels.map(q=>agg[q].companies.light), backgroundColor:'rgba(168,85,247,0.8)', borderColor:'#a855f7', borderWidth:1 },
        { label:'매입 없음', data:labels.map(q=>agg[q].companies.none), backgroundColor:'#1a1a1a', borderColor:'#2a2a2a', borderWidth:1 },
      ]
    }, options:opts
  });
}

// ============================================
// TABS & INIT
// ============================================
function setupTabs(data) {
  const tabs = document.querySelectorAll('#rankTabs .tab-btn');
  tabs.forEach(btn => {
    btn.addEventListener('click', function() {
      tabs.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      renderRanking(data, this.dataset.view);
    });
  });
}

async function init() {
  try {
    const resp = await fetch(DATA_URL);
    if (!resp.ok) throw new Error('Data not found');
    const raw = await resp.json();
    const data = raw.data || {};
    GLOBAL_DATA = data;
    const total = raw.sp500_list?.length || 500;
    const collected = Object.keys(data).length;

    document.getElementById('lastUpdate').textContent = raw.last_updated?.substring(0,10) || '-';
    document.getElementById('coverage').textContent = `${collected}/${total}개`;

    if (collected < 10) {
      document.getElementById('rankListContainer').innerHTML =
        '<div class="data-status">아직 충분한 데이터가 수집되지 않았습니다.<br>매일 50개 종목씩 수집중입니다. (현재 '+collected+'개)</div>';
      return;
    }

    renderStats(data);
    renderRanking(data, 'amount');
    renderTrendChart(data);
    renderSectorChart(data);
    renderYieldTable(data);
    renderBreadthChart(data);
    setupTabs(data);

    const topSymbol = Object.entries(data)
      .map(([s,i]) => ({ s, ttm: getTTMBuyback(i.quarters) }))
      .sort((a,b) => b.ttm - a.ttm)[0]?.s;
    if (topSymbol) showDetailChart(topSymbol);

  } catch (e) {
    console.error('Failed to load data:', e);
    document.getElementById('rankListContainer').innerHTML =
      '<div class="data-status">데이터를 불러올 수 없습니다.<br>buyback_data.json 파일을 확인해주세요.</div>';
  }
}

init();
</script>
</body>
</html>
